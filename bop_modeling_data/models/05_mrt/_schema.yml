version: 2

models:
  - name: dm__npc_counts
    description: 'Data mart model for NPC (Net Premium Change) counts. It calculates prior year activities and aggregates counts and amounts. Materialized as a table. It references `fct__billing_activity` and `lkp__associated_policies`.'
    config:
      materialized: table
    columns:
      - name: sb_policy_key
        description: 'The `associated_sb_policy_key` from `lkp__associated_policies`, representing the anchor small business policy for which prior year activity is being calculated.'
        tests:
          - not_null
          - relationships:
              to: ref('lkp__associated_policies')
              field: associated_sb_policy_key
      - name: policy_chain_id
        description: 'The `policy_chain_id` associated with the `sb_policy_key`.'
        tests:
          - not_null
      - name: policy_eff_date
        description: 'The effective date of the anchor `sb_policy_key`.'
        tests:
          - not_null
      - name: prior_yr1_c_activity_count
        description: "Count of 'C' type billing activities in the 1st prior year to the policy_eff_date."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      - name: prior_yr1_c_activity_amount_sum
        description: "Sum of amounts for 'C' type billing activities in the 1st prior year."
      - name: prior_yr2_c_activity_count
        description: "Count of 'C' type billing activities in the 2nd prior year."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      - name: prior_yr2_c_activity_amount_sum
        description: "Sum of amounts for 'C' type billing activities in the 2nd prior year."
      - name: prior_yr3_c_activity_count
        description: "Count of 'C' type billing activities in the 3rd prior year."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      - name: prior_yr3_c_activity_amount_sum
        description: "Sum of amounts for 'C' type billing activities in the 3rd prior year."
      - name: prior_yr4_c_activity_count
        description: "Count of 'C' type billing activities in the 4th prior year."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      - name: prior_yr4_c_activity_amount_sum
        description: "Sum of amounts for 'C' type billing activities in the 4th prior year."
      - name: prior_yr5_c_activity_count
        description: "Count of 'C' type billing activities in the 5th prior year."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      - name: prior_yr5_c_activity_amount_sum
        description: "Sum of amounts for 'C' type billing activities in the 5th prior year."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - sb_policy_key
