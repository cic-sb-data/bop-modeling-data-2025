models:
  - name: lkp__associated_policies
    description: |
      Critical lookup model that establishes relationships between policies within policy chains. 
      Its primary purpose is to enable the identification of all historically associated policies for any given policy processed in the decfile.

      Key functionalities:
      1. Creates associations between policies using their common `policy_chain_id`.
      2. Links each policy (identified by its five-field compound key: `company_numb`, `policy_sym`, `policy_numb`, `policy_module`, `policy_eff_date`) within a chain to the corresponding `sb_policy_key` from the decfile source (`stg__decfile__sb_policy_lookup`).
      3. Sources policy chain information from `stg__modcom__policy_chain_v3`.
      4. Generates `associated_policy_key` (a hash key for the five-key) and `associated_sb_policy_key` (the `sb_policy_key` linked to the chain members).
      5. Serves as a foundational lookup table for downstream analytical processes, including `lkp__billing_policies`, `fct__associated_policy_eff_date`, and `dm__npc_counts`.

      The model aims to provide a comprehensive view of all policies associated with a given `sb_policy_key` through its policy chain.
      Refer to `/Users/andy/bop-modeling-data-2025/lkp__associated_policies.md` for detailed design, optimization plans, and historical context.
    columns:
      - name: associated_policy_key
        description: 'Surrogate key (hash of the five-key components) for each policy instance within a policy chain.'
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_not_be_null
      - name: associated_sb_policy_key
        description: 'The sb_policy_key from the decfile that is associated with this policy chain instance.'
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_not_be_null
      - name: policy_chain_id
        description: 'Identifier for the policy chain.'
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_not_be_null
      - name: company_numb
        description: "Company number component of the policy's five-key."
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_not_be_null
          - dbt_expectations.expect_column_values_to_be_in_set:
              value_set: [1, 3, 5, 7]
      - name: policy_sym
        description: "Policy symbol component of the policy's five-key."
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_not_be_null
          - dbt_expectations.expect_column_value_lengths_to_be_between:
              min_value: 1
              max_value: 3
      - name: policy_numb
        description: "Policy number component of the policy's five-key."
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_not_be_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1
              max_value: 9999999
      - name: policy_module
        description: "Policy module component of the policy's five-key."
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_not_be_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 999
      - name: policy_eff_date
        description: "Policy effective date component of the policy's five-key."
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_not_be_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: date
    data_tests:
      - dbt_expectations.expect_compound_columns_to_be_unique:
          column_list: [ "associated_policy_key", "associated_sb_policy_key" ]

  - name: lkp__billing_policies
    description: 'Associates billing data with policies, linking sb_policy_key to billing system keys.'
    columns:
      - name: billing_sb_policy_key
        description: 'Key for billing small business policy.'
        data_tests:
          - dbt_expectations.expect_column_min_to_be_between:
              min_value: 0
              max_value: 10
          - dbt_expectations.expect_column_to_exist
        data_type: bigint
      - name: associated_policy_key
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - relationships:
              field: associated_policy_key
              to: ref('lkp__associated_policies')
        data_type: hugeint
      - name: billing_acct_key
        data_tests:
          - dbt_expectations.expect_column_to_exist
        data_type: bigint
      - name: billing_policy_key
        data_tests:
          - dbt_expectations.expect_column_to_exist
        data_type: hugeint
      - name: associated_sb_policy_key
        data_type: uinteger
        data_tests:
          - dbt_expectations.expect_column_min_to_be_between:
              min_value: 0
              max_value: 10
      - name: billing_policy_id
        data_type: varchar
      - name: billing_acct_id
        data_type: varchar
      - name: policy_sym
        data_type: varchar
      - name: policy_numb
        data_type: uinteger
      - name: policy_eff_date
        data_type: date

  - name: lkp__dates
    description: 'Generates a date dimension table, potentially including prior year flags or calculations.'
    columns:
      - name: input_date
        description: 'The base date for generating prior year dates.'
        data_tests:
          - dbt_expectations.expect_column_to_exist
      - name: n_prior_years
        data_tests:
          - dbt_expectations.expect_column_to_exist
      - name: prior_year_start
        data_tests:
          - dbt_expectations.expect_column_to_exist
      - name: prior_year_end
        data_tests:
          - dbt_expectations.expect_column_to_exist
    data_tests:
      - dbt_utils.expression_is_true:
          expression: 'prior_year_end >= prior_year_start'

  - name: lkp__first_billing_activity_date
    description: 'Determines the first billing activity date for relevant entities.'
    columns:
      - name: activity_trans_key
        data_tests:
          - dbt_expectations.expect_column_to_exist
      - name: first_billing_activity_date
        data_tests:
          - dbt_expectations.expect_column_to_exist

  - name: lkp__policy_chain_ids
    description: 'Processes and provides distinct policy chain identifiers and associated counts.'
    columns:
      - name: policy_chain_id
        description: 'Identifier for the policy chain.'
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - relationships:
              to: ref('stg__decfile__sb_policy_lookup')
              field: policy_chain_id
          - relationships:
              to: ref('stg__modcom__policy_chain_v3')
              field: policy_chain_id
      - name: n_sb_policies_for_policy_chain_id
        data_tests:
          - dbt_expectations.expect_column_min_to_be_between:
              min_value: 0
              max_value: 10
          - dbt_expectations.expect_column_to_exist
      - name: n_total_policies_for_policy_chain_id
        data_tests:
          - dbt_expectations.expect_column_min_to_be_between:
              min_value: 0
              max_value: 10
          - dbt_expectations.expect_column_to_exist

  - name: lkp__sb_policy_key
    description: 'Provides a lookup for small business policy keys, primarily sourced from stg__decfile__sb_policy_lookup.'
    columns:
      - name: sb_policy_key
        data_tests:
          - dbt_expectations.expect_column_min_to_be_between:
              min_value: 0
              max_value: 10
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_be_unique
      - name: policy_chain_id
        data_tests:
          - dbt_expectations.expect_column_to_exist
      - name: lob
        data_tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_be_in_set:
              value_set: 
                - prop
                - liab
      - name: company_numb
        data_tests:
          - dbt_expectations.expect_column_to_exist
      - name: policy_sym
        data_tests:
          - dbt_expectations.expect_column_to_exist
      - name: policy_numb
        data_tests:
          - dbt_expectations.expect_column_to_exist
      - name: policy_module
        data_tests:
          - dbt_expectations.expect_column_to_exist
      - name: policy_eff_date
        data_tests:
          - dbt_expectations.expect_column_to_exist
