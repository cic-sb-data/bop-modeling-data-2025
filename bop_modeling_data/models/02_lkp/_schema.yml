models:
  - name: lkp__associated_policies
    description: |
      Lookup model that identifies all policies associated with each small business (SB) policy originating from the decfile process.
      It links each `sb_policy_key` (from `stg__decfile__sb_policy_lookup`) to every policy (company_numb, policy_sym, policy_numb, policy_module, policy_eff_date)
      found within the same `policy_chain_id` (from `stg__modcom__policy_chain_v3`).
      The `associated_policy_key` is generated for each policy in the chain using the `policy_key()` macro.
      The grain of this model is the combination of `associated_policy_key` and `associated_sb_policy_key`,
      meaning each record represents a unique link between a policy in a chain and an SB policy key that shares that chain.
      This model is crucial for understanding the full history and relationships of policies connected through a policy chain.
    columns:
      - name: associated_policy_key
        description: 'A unique key for each policy (company_numb, policy_sym, policy_numb, policy_module, policy_eff_date) found in a policy chain that is associated with an sb_policy_key. Generated by the `policy_key()` macro.'
        data_tests:
          - not_null
      - name: associated_sb_policy_key
        description: 'The `sb_policy_key` from the decfile process. This key identifies a specific small business policy term and line of business (e.g., property or liability). It is the anchor for finding all other associated policies in the chain.'
        data_tests:
          - not_null
      - name: policy_chain_id
        description: 'Identifier for the policy chain. Links the `associated_sb_policy_key` to all policies within its chain.'
        data_tests:
          - not_null
          - relationships:
              to: ref('stg__modcom__policy_chain_v3')
              field: policy_chain_id
      - name: company_numb
        description: 'Component of the five-field policy key: Company number.'
        data_tests:
          - not_null
      - name: policy_sym
        description: 'Component of the five-field policy key: Policy symbol.'
        data_tests:
          - not_null
      - name: policy_numb
        description: 'Component of the five-field policy key: Policy number.'
        data_tests:
          - not_null
      - name: policy_module
        description: 'Component of the five-field policy key: Policy module.'
        data_tests:
          - not_null
      - name: policy_eff_date
        description: 'Component of the five-field policy key: Policy effective date.'
        data_tests:
          - not_null
    data_tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - associated_policy_key
            - associated_sb_policy_key

  - name: lkp__billing_policies
    description: 'Lookup model for billing policies. It filters raw billing policies and adds a billing_sb_policy_key. It references `lkp__associated_policies`.'
    columns:
      - name: billing_sb_policy_key
        description: 'Key for billing small business policy.'
        data_tests:
          - not_null
      - name: associated_policy_key
        data_tests:
          - not_null
          - relationships:
              to: ref('lkp__associated_policies')
              field: associated_policy_key
      - name: billing_acct_key
        data_tests:
          - not_null
      - name: billing_policy_key
        data_tests:
          - not_null

  - name: lkp__dates
    description: 'Lookup model for dates, generating prior year columns.'
    columns:
      - name: input_date
        description: 'The base date for generating prior year dates.'
        data_tests:
          - not_null
      - name: n_prior_years
        data_tests:
          - not_null
      - name: prior_year_start
        data_tests:
          - not_null
      - name: prior_year_end
        data_tests:
          - not_null
    data_tests: # Model-level data_tests
      - dbt_utils.expression_is_true:
          expression: 'prior_year_end >= prior_year_start'

  - name: lkp__first_billing_activity_date
    description: 'Lookup model to determine the first billing activity date for a policy. It references `fct__billing_activity`.'
    columns:
      - name: activity_trans_key
        data_tests:
          - not_null
          - relationships:
              to: ref('fct__billing_activity')
              field: activity_trans_key
      - name: first_billing_activity_date
        data_tests:
          - not_null

  - name: lkp__policy_chain_ids
    description: 'Lookup model for policy chain IDs, counting total policies associated with each chain.'
    columns:
      - name: policy_chain_id
        description: 'Identifier for the policy chain.'
        data_tests:
          - not_null
          - relationships:
              to: ref('stg__decfile__sb_policy_lookup')
              field: policy_chain_id
          - relationships:
              to: ref('stg__modcom__policy_chain_v3')
              field: policy_chain_id
      - name: n_sb_policies_for_policy_chain_id
        data_tests:
          - not_null
      - name: n_total_policies_for_policy_chain_id
        data_tests:
          - not_null

  - name: lkp__sb_policy_key
    description: 'Lookup model for small business policy keys.'
    columns:
      - name: sb_policy_key
        data_tests:
          - unique
          - not_null
      - name: policy_chain_id
        data_tests:
          - not_null
      # Add not_null for other critical columns as identified in stg layer
      - name: lob
        data_tests:
          - not_null
      - name: company_numb
        data_tests:
          - not_null
      - name: policy_sym
        data_tests:
          - not_null
      - name: policy_numb
        data_tests:
          - not_null
      - name: policy_module
        data_tests:
          - not_null
      - name: policy_eff_date
        data_tests:
          - not_null
